# Developer Setup Guide

Welcome to the Childhood Disability Advocacy Hub (CDAH) project. This guide describes the full development workflow for the Express/MongoDB backend located in `Backend/` and the Vite/React frontend located in `CDNC-frontend/`.

---

## 1. Architecture at a Glance

* **Backend (`Backend/`)** – An Express app that exposes authentication, Member of Parliament lookup, and community enrollment APIs. Requests are wired in `app.js`, MongoDB connectivity and startup live in `server.js`, and domain logic sits under `controller/` and `utils/`.
* **Frontend (`CDNC-frontend/`)** – A Vite-powered single-page application that calls the backend through the shared axios client in `src/lib/api.ts` and renders routed experiences from `src/pages/`.

Understanding this split is key when troubleshooting: the frontend proxies API calls to whatever base URL is configured in `VITE_API_URL`, and the backend assumes the Mongo database and optional SMTP/webhook integrations are reachable before accepting requests.

---

## 2. Prerequisites & Tooling

| Requirement | Notes |
| --- | --- |
| **Node.js 18+** | Matches the engines used during development and supports native `fetch` in case you add SSR utilities later.
| **npm 9+** | Bundled with modern Node releases; no lockfiles for yarn/pnpm are committed.
| **MongoDB 6+** | Local instance or a hosted cluster. The app connects via a `MONGO_URI` connection string.
| **Git** | Clone this repository and manage feature branches.
| Optional services | SMTP credentials for transactional mail and an HTTPS endpoint to receive analytics webhooks.

> Tip: Install [nvm](https://github.com/nvm-sh/nvm) so every contributor can align on the same Node version quickly.

---

## 3. Clone & Install Dependencies

```bash
git clone <your-fork-or-origin>
cd CDAH

# Backend dependencies
cd Backend
npm install

# Frontend dependencies
cd ../CDNC-frontend
npm install
```

Both packages rely exclusively on the `package-lock.json` that ships with the repo, so `npm install` is deterministic.

---

## 4. Configure Environment Variables

### Backend (`Backend/.env`)

Create a `.env` file next to `server.js`:

```dotenv
MONGO_URI=mongodb://localhost:27017/cdah
JWT_SECRET=change-me
PORT=5001

# Optional
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=super-secret
EMAIL_FROM=advocacy@example.com
EMAIL_FROM_NAME="CDAH Team"
ANALYTICS_WEBHOOK_URL=https://example.com/hooks/enrollment
```

* `MONGO_URI` is required for `mongoose.connect` in `server.js` to succeed.【F:Backend/server.js†L3-L27】
* `JWT_SECRET` feeds the signing logic in `utils/jwt.js` and should be unique per environment.【F:Backend/utils/jwt.js†L1-L13】
* SMTP keys are optional: missing values simply skip sending emails in `utils/notifications.js` but the API still returns success.【F:Backend/utils/notifications.js†L32-L122】

### Frontend (`CDNC-frontend/.env.local`)

Create `.env.local` in the frontend directory:

```dotenv
VITE_API_URL=http://localhost:5001/api
```

If you omit this variable, the axios client falls back to the same default URL, but setting it explicitly makes it obvious which backend instance you target.【F:CDNC-frontend/src/lib/api.ts†L1-L22】

---

## 5. Run the Stack Locally

1. **Start MongoDB** (for example `brew services start mongodb-community@6.0` on macOS).
2. **Boot the backend**:
   ```bash
   cd Backend
   npm run dev
   ```
   * `server.js` reads the `.env`, ensures Mongo indexes exist with `User.syncIndexes()` and `Member.syncIndexes()`, then starts the HTTP server on `PORT` or `5001` by default.【F:Backend/server.js†L7-L28】
   * API routes are mounted under `/api/auth`, `/api/mps`, and `/api/members` via `app.use` in `app.js`.【F:Backend/app.js†L1-L31】
3. **Boot the frontend**:
   ```bash
   cd CDNC-frontend
   npm run dev
   ```
   * Vite serves the SPA on `http://localhost:5173` unless you override the port. Pages load React Query, router, and other providers from `src/App.tsx`.【F:CDNC-frontend/src/App.tsx†L1-L38】
4. **Visit** `http://localhost:5173` and confirm that joining the community, searching MPs, and authentication flows all reach the API successfully.

---

## 6. Working with Data

* **Authentication** – Register new users by POSTing to `/api/auth/register`; the controller hashes passwords with bcrypt and rejects duplicate emails.【F:Backend/controller/auth.controller.js†L1-L47】
* **Login** – `/api/auth/login` trims/lowercases email, compares hashes, and returns a JWT plus user metadata on success.【F:Backend/controller/auth.controller.js†L49-L78】
* **Community enrollment** – POST to `/api/members` with `name`, `email`, `role`, and `agreeToTerms`. The controller validates fields, normalizes emails, and triggers optional email/webhook side effects after creating the record.【F:Backend/controller/member.controller.js†L1-L64】
* **MP directory** – Populate the `MPContacts` and `MPEmail` collections with your own datasets; lookup logic merges both collections inside `controller/mp.controller.js`.【F:Backend/controller/mp.controller.js†L1-L60】

Seed data through Mongo shell, Compass, or by scripting test fixtures with the exposed endpoints.

---

## 7. Automated Testing & Quality Gates

### Backend

```bash
cd Backend
npm test
```
Runs Jest in serial mode (`--runInBand`) as defined in `package.json` so that database-dependent tests remain deterministic.【F:Backend/package.json†L1-L26】

### Frontend

```bash
cd CDNC-frontend
npm run lint      # ESLint across the project
npm run build     # Production build to dist/
npm run preview   # Serve the build locally
```
Scripts live in `package.json` and should pass before opening pull requests.【F:CDNC-frontend/package.json†L1-L36】

### Cypress End-to-End Suite

```bash
cd CDNC-frontend
npm run test:e2e:open   # Interactive mode
npm run test:e2e:run    # Headless CI mode
```
* Update the `baseUrl` in `cypress.config.cjs` if your Vite dev server runs on a non-default port. The template currently targets `http://localhost:8080`—change it to `5173` for local development.【F:CDNC-frontend/cypress.config.cjs†L1-L9】
* Start both backend and frontend servers before running the tests so routes like `/join` and `/send-letter` can complete flows end-to-end.

---

## 8. Debugging Tips

* **API errors** – Backend controllers log explicit error messages before returning HTTP errors. Watch the terminal running `npm run dev` for the `❌` logs emitted from controllers such as `member.controller.js` or `auth.controller.js` when validation fails.【F:Backend/controller/member.controller.js†L33-L63】【F:Backend/controller/auth.controller.js†L29-L77】
* **Unhandled routes** – Requests to unknown `/api/*` paths return JSON 404 responses thanks to the fallback middleware in `app.js`; this helps detect typos in frontend API calls.【F:Backend/app.js†L13-L24】
* **CORS** – `app.js` enables CORS globally with `app.use(cors())`, so cross-origin issues typically stem from the wrong `VITE_API_URL`.【F:Backend/app.js†L1-L15】【F:CDNC-frontend/src/lib/api.ts†L1-L22】
* **Mongo indexes** – On every cold start, `server.js` calls `User.syncIndexes()` and `Member.syncIndexes()`. If you change schemas in `Data/`, restart the server to refresh indexes automatically.【F:Backend/server.js†L7-L21】

---

## 9. Project Structure Reference

```
Backend/
  app.js                # Express app, middleware, route mounting
  server.js             # Mongo connection + HTTP bootstrap
  routes/               # API route definitions
  controller/           # Request handlers
  utils/                # JWT, notifications, validation helpers
CDNC-frontend/
  src/App.tsx           # Providers, router, global layout
  src/pages/            # Feature pages (JoinCommunity, SendLetter, etc.)
  src/lib/api.ts        # Axios client with environment-driven base URL
  cypress/              # End-to-end specs and fixtures
```

---

## 10. Collaboration Workflow

* Create feature branches from `main` (e.g., `git checkout -b feature/join-form-copy`).
* Commit frequently and run tests before pushing.
* Use pull requests to merge changes; Cypress and Jest commands above can serve as CI checks.
* Keep `.env` files out of source control—`git status` should always show them as untracked.

---

## 11. Troubleshooting Reference

| Symptom | Likely Cause | Resolution |
| --- | --- | --- |
| `❌ Mongo error` during backend startup | Wrong `MONGO_URI` or MongoDB offline. | Verify credentials and network access; the server logs the raw error before exiting.【F:Backend/server.js†L13-L27】 |
| Login always fails | Password stored without hashing or email mismatch. | Ensure registrations go through the `/api/auth/register` endpoint, which hashes with bcrypt before saving.【F:Backend/controller/auth.controller.js†L16-L38】 |
| Enrollment emails skipped | SMTP variables unset. | Provide SMTP credentials or accept the logged warning—`create` still returns `201`.【F:Backend/controller/member.controller.js†L1-L64】【F:Backend/utils/notifications.js†L32-L122】 |
| MP search returns empty results | `MPContacts` / `MPEmail` collections empty. | Import data into Mongo; lookup logic lives in `controller/mp.controller.js`.【F:Backend/controller/mp.controller.js†L1-L60】 |
| Frontend API calls hit 404 | Route mismatch or stale base URL. | Confirm the requested path exists in `app.js` and that `VITE_API_URL` is pointed at the correct environment.【F:Backend/app.js†L4-L24】【F:CDNC-frontend/src/lib/api.ts†L1-L22】 |
| Cypress specs fail instantly | Dev server not running or wrong port configured. | Start `npm run dev` for both apps and update `baseUrl` in `cypress.config.cjs`.【F:CDNC-frontend/cypress.config.cjs†L1-L9】 |

Happy building!
