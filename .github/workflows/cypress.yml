name: ⚙️ Cypress E2E

on:
  push:
    branches: [ cypress-e2e-testing ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      BACKEND_DIR: Backend
      FRONTEND_DIR: CDNC-frontend
      NODE_VERSION: 18
      FRONTEND_PORT: 8080
      BACKEND_PORT: 5001   # different from frontend

    steps:
      - name: ⬇️ Checkout Code
        uses: actions/checkout@v4

      - name: 🧪 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # ---------- Backend on 3001 ----------
      - name: 📦 Install Backend Dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      - name: 🟢 Start Backend
        working-directory: ${{ env.BACKEND_DIR }}
        env:
          MONGO_URI: ${{ secrets.mongoUri }}
          JWT_SECRET: ${{ secrets.JWT_seceret }}
          PORT: ${{ env.BACKEND_PORT }}     # force 3001 in CI
        run: |
          npm run dev 

      # ---------- Frontend on 8080 ----------
      - name: 📦 Install Frontend Dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: 🖥️ Start Frontend (Vite on 8080)
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          VITE_API_BASE_URL: http://localhost:${{ env.BACKEND_PORT }}
        run: |
          # Force Vite to use 8080 and fail if taken
          npm run dev 

      # ---------- Wait for both servers ----------
      - name: ⏳ Wait for servers
        run: |
          npx --yes wait-on http://localhost:${{ env.BACKEND_PORT }}
          npx --yes wait-on http://localhost:${{ env.FRONTEND_PORT }}

      # ---------- Cypress ----------
      - name: 🧭 Run Cypress E2E
        uses: cypress-io/github-action@v6
        with:
          working-directory: ${{ env.FRONTEND_DIR }}
          install: true
          browser: chrome
          # baseUrl is your 8080 frontend
          config: baseUrl=http://localhost:${{ env.FRONTEND_PORT }}
          spec: |
            cypress/e2e/login.cy.js
            cypress/e2e/signin.cy.js
          wait-on: "http://localhost:${{ env.FRONTEND_PORT }},http://localhost:${{ env.BACKEND_PORT }}"
          wait-on-timeout: 120000

      # ---------- Artifacts & Cleanup ----------
      - name: 📎 Upload Cypress Artifacts (on fail)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            CDNC-frontend/cypress/screenshots
            CDNC-frontend/cypress/videos

      - name: 🧹 Stop Servers & Show Logs
        if: always()
        run: |
          kill $(cat backend.pid) 2>/dev/null || true
          kill $(cat frontend.pid) 2>/dev/null || true
          echo "—— BACKEND LOG ——"
          tail -n 200 backend.log || true
          echo "—— FRONTEND LOG ——"
          tail -n 200 frontend.log || true
