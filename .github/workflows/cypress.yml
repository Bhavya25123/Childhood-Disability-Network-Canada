name: âš™ï¸ Cypress E2E

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest

    # Needed to create PRs with GITHUB_TOKEN
    permissions:
      contents: write
      pull-requests: write

    env:
      BACKEND_DIR: Backend
      FRONTEND_DIR: CDNC-frontend
      NODE_VERSION: 18
      FRONTEND_PORT: 8080
      BACKEND_PORT: 5001

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§ª Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # ---------- Backend (background) ---------
      - name: ðŸ“¦ Install Backend Dependencies
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm ci

      - name: ðŸŸ¢ Start Backend
        working-directory: ${{ env.BACKEND_DIR }}
        env:
          # Provide both names in case code reads either
          MONGODB_URI: ${{ secrets.MONGO_URI }}
          MONGO_URI:   ${{ secrets.MONGO_URI }}
          JWT_SECRET:  ${{ secrets.JWT_SECRET || secrets.JWT_seceret }}
          PORT:        ${{ env.BACKEND_PORT }}
        run: |
          nohup npm run dev > ../backend.log 2>&1 &
          echo $! > ../backend.pid

      # ---------- Frontend (background) ----------
      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: ðŸ–¥ï¸ Start Frontend (Vite on 8080)
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          VITE_API_BASE_URL: http://localhost:${{ env.BACKEND_PORT }}
        run: |
          nohup npm run dev -- --port $FRONTEND_PORT --strictPort > ../frontend.log 2>&1 &
          echo $! > ../frontend.pid

      # ---------- Tail logs + Wait ----------
      - name: ðŸªµ Tail logs (background)
        run: |
          tail -n +1 -f backend.log frontend.log &
          echo $! > tail.pid

      - name: â³ Wait for frontend to be ready
        run: npx wait-on http://localhost:8080 --timeout 120000
        
      # ----------jest-super+test ---------
      - name: â–¶ï¸ Run Jest Tests
        working-directory: ${{ env.BACKEND_DIR }}
        run: npm test

      - name: ðŸ“Ž Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: ${{ env.BACKEND_DIR }}/coverage
          if-no-files-found: ignore

      
      # ---------- Cypress ----------
      - name: ðŸ§ª Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: CDNC-frontend
          install: false
          config-file: cypress.config.cjs
          wait-on: 'http://localhost:8080'
          wait-on-timeout: 120000
      
      # ---------- Create/Update PR master -> main if tests passed ----------
      - name: ðŸ”€ Open PR to main
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            // Is there already an open PR from master -> main?
            const { data: openPRs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:master`,
              base: 'main'
            });
            if (openPRs.length) {
              core.info(`PR already open: #${openPRs[0].number}`);
            } else {
              const { data: pr } = await github.rest.pulls.create({
                owner,
                repo,
                title: "âœ… E2E passed: Merge master â†’ main",
                head: "master",
                base: "main",
                body: "Auto-created after Cypress E2E passed on master."
              });
              core.info(`Created PR #${pr.number}`);
            }

      # ---------- Artifacts & Cleanup ----------
      - name: ðŸ“Ž Upload Cypress Artifacts (on fail)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            CDNC-frontend/cypress/screenshots
            CDNC-frontend/cypress/videos
            backend.log
            frontend.log

      - name: ðŸ§¹ Stop Servers & Show Logs
        if: always()
        run: |
          kill $(cat tail.pid) 2>/dev/null || true
          kill $(cat backend.pid) 2>/dev/null || true
          kill $(cat frontend.pid) 2>/dev/null || true
          echo "â€”â€” BACKEND LOG â€”â€”"; tail -n 200 backend.log || true
          echo "â€”â€” FRONTEND LOG â€”â€”"; tail -n 200 frontend.log || true
